<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .loading { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover { background: #2563eb; }
        .test-results {
            background: #f3f4f6;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî• Firebase Connection Test</h1>
        <p>This page tests the Firebase connection with your project: <strong>efforts-celebrations</strong></p>
        
        <div id="status" class="status loading">
            Initializing Firebase...
        </div>
        
        <div class="test-controls">
            <button class="test-button" onclick="testFirestoreConnection()">Test Firestore</button>
            <button class="test-button" onclick="testImageCompression()">Test Image Compression</button>
            <button class="test-button" onclick="createSampleData()">Create Sample Data</button>
            <button class="test-button" onclick="clearTestData()">Clear Test Data</button>
        </div>
        
        <div id="results" class="test-results"></div>
        
        <div class="instructions">
            <h3>üìù Setup Instructions</h3>
            <ol>
                <li><strong>Enable Firestore:</strong> Go to Firebase Console ‚Üí Firestore Database ‚Üí Create database (Test mode)</li>
                <li><strong>Skip Storage:</strong> Firebase Storage is a paid feature, we'll use Base64 images instead</li>
                <li><strong>Check Console:</strong> Look for any error messages in browser console (F12)</li>
                <li><strong>Security Rules:</strong> For testing, use test mode rules (update for production)</li>
            </ol>
            
            <h3>üîç Expected Results</h3>
            <ul>
                <li>‚úÖ Firebase initialization should show "Connected"</li>
                <li>‚úÖ Firestore test should create/read/delete a document</li>
                <li>‚úÖ Image compression test should work (for profile pictures)</li>
                <li>‚úÖ Sample data creation should populate collections</li>
            </ul>
            
            <h3>üí° Image Handling</h3>
            <p><strong>Since Firebase Storage is paid:</strong></p>
            <ul>
                <li>üì∑ Student profile images are stored as compressed Base64 (max 100KB)</li>
                <li>üîó Reward images can use external URLs (Google Drive, Imgur, etc.)</li>
                <li>üì± Images are automatically compressed to 300px max dimension</li>
                <li>üíæ All images stored directly in Firestore documents</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK (Firestore only - Storage is paid) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDORRABIK1fPpreVGRNwwQbfTFMYH-cysM",
            authDomain: "efforts-celebrations.firebaseapp.com",
            projectId: "efforts-celebrations",
            storageBucket: "efforts-celebrations.firebasestorage.app",
            messagingSenderId: "14557716507",
            appId: "1:14557716507:web:9e751db40ebb133be358be",
            measurementId: "G-RJCDD0CB6D"
        };

        // Initialize Firebase
        let db;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'color: red;' : type === 'success' ? 'color: green;' : '';
            results.innerHTML += `<div style="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Initialize Firebase (Firestore only - Storage is paid)
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            updateStatus('‚úÖ Firebase initialized successfully! (Firestore only)', 'success');
            log('Firebase initialized with project: efforts-celebrations', 'success');
            log('Note: Using Firestore only - Storage is paid feature', 'info');
        } catch (error) {
            updateStatus(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
            log(`Firebase initialization error: ${error.message}`, 'error');
        }

        async function testFirestoreConnection() {
            log('üî• Testing Firestore connection...');
            
            try {
                // Create a test document
                const testDoc = await db.collection('test').add({
                    message: 'Firestore connection test',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testId: Date.now()
                });
                
                log(`‚úÖ Document created with ID: ${testDoc.id}`, 'success');
                
                // Read the document back
                const doc = await testDoc.get();
                if (doc.exists) {
                    log('‚úÖ Document read successfully', 'success');
                    log(`Data: ${JSON.stringify(doc.data())}`, 'info');
                } else {
                    log('‚ùå Document not found after creation', 'error');
                }
                
                // Delete the test document
                await testDoc.delete();
                log('‚úÖ Test document deleted', 'success');
                
                updateStatus('‚úÖ Firestore connection successful!', 'success');
                
            } catch (error) {
                log(`‚ùå Firestore test failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Firestore connection failed: ${error.message}`, 'error');
            }
        }

        async function testImageCompression() {
            log('ÔøΩÔ∏è Testing image compression (Base64 alternative to Storage)...');
            
            try {
                // Create a test image (small colored canvas)
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // Draw a colorful test pattern
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(0, 0, 50, 50);
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(50, 0, 50, 50);
                ctx.fillStyle = '#10b981';
                ctx.fillRect(0, 50, 50, 50);
                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(50, 50, 50, 50);
                
                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                log(`‚úÖ Created test image: ${blob.size} bytes`, 'success');
                
                // Test Base64 conversion
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                });
                
                log(`‚úÖ Base64 conversion successful: ${base64.length} characters`, 'success');
                
                // Test storing in Firestore
                const testDoc = await db.collection('test').add({
                    type: 'image_test',
                    imageData: base64,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                log('‚úÖ Base64 image stored in Firestore', 'success');
                
                // Clean up test document
                await testDoc.delete();
                log('‚úÖ Test image document deleted', 'success');
                
                updateStatus('‚úÖ Image compression system working!', 'success');
                
            } catch (error) {
                log(`‚ùå Image compression test failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Image compression test failed: ${error.message}`, 'error');
            }
        }

        async function createSampleData() {
            log('üìä Creating sample campus data...');
            
            try {
                const batch = db.batch();
                
                const campusData = [
                    { name: 'Pune Campus', points: 1340, rank: 1, trend: 'up', rewards: 18, id: 'pune' },
                    { name: 'Dharamshala Campus', points: 1220, rank: 2, trend: 'down', rewards: 15, id: 'dharamshala' },
                    { name: 'Raigarh Campus', points: 1140, rank: 3, trend: 'up', rewards: 12, id: 'raigarh' }
                ];
                
                campusData.forEach(campus => {
                    const docRef = db.collection('campuses').doc(campus.id);
                    batch.set(docRef, {
                        ...campus,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                log(`‚úÖ Created ${campusData.length} campus records`, 'success');
                
                // Create sample student data
                const studentData = [
                    { studentId: 'S001', name: 'John Doe', campus: 'pune', house: 'bageshree', points: { academic: 890, lifeSkills: 340, attendance: 15 } },
                    { studentId: 'S002', name: 'Jane Smith', campus: 'dharamshala', house: 'bhairav', points: { academic: 750, lifeSkills: 420, placement: 15 } }
                ];
                
                const studentBatch = db.batch();
                studentData.forEach(student => {
                    const docRef = db.collection('students').doc(student.studentId);
                    studentBatch.set(docRef, {
                        ...student,
                        totalPoints: Object.values(student.points).reduce((a, b) => a + b, 0),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await studentBatch.commit();
                log(`‚úÖ Created ${studentData.length} student records`, 'success');
                
                updateStatus('‚úÖ Sample data created successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Sample data creation failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Sample data creation failed: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            log('üóëÔ∏è Clearing test data...');
            
            try {
                // Clear test collection
                const testSnapshot = await db.collection('test').get();
                const batch = db.batch();
                
                testSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                log(`‚úÖ Cleared ${testSnapshot.size} test documents`, 'success');
                
                updateStatus('‚úÖ Test data cleared!', 'success');
                
            } catch (error) {
                log(`‚ùå Clear test data failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Clear test data failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
