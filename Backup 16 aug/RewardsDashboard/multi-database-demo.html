<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Database Firebase Demo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .database-status {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .database-status.unhealthy {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .database-status.healthy {
            border-left-color: #4CAF50;
            background: #e8f5e8;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .log-container {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .config-section {
            margin-bottom: 20px;
        }
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .sync-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .stat-item h3 {
            margin: 0;
            font-size: 24px;
            color: #4CAF50;
        }
        .stat-item p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-database"></i> Multi-Database Firebase Management</h1>
        
        <!-- Database Status -->
        <div class="card">
            <h2><i class="fas fa-heartbeat"></i> Database Health Status</h2>
            <div class="status-grid" id="database-status">
                <!-- Status cards will be populated here -->
            </div>
            <button class="btn" onclick="checkDatabaseHealth()">
                <i class="fas fa-sync"></i> Refresh Health Check
            </button>
        </div>

        <!-- Sync Statistics -->
        <div class="card">
            <h2><i class="fas fa-chart-line"></i> Sync Statistics</h2>
            <div class="sync-stats" id="sync-stats">
                <div class="stat-item">
                    <h3 id="db-count">0</h3>
                    <p>Connected Databases</p>
                </div>
                <div class="stat-item">
                    <h3 id="queue-size">0</h3>
                    <p>Queue Size</p>
                </div>
                <div class="stat-item">
                    <h3 id="sync-status">OFF</h3>
                    <p>Sync Status</p>
                </div>
            </div>
        </div>

        <!-- Secondary Database Configuration -->
        <div class="card">
            <h2><i class="fas fa-cog"></i> Add Secondary Database</h2>
            <p>Configure a second Firebase project for backup and sync:</p>
            <div class="config-section">
                <input type="text" class="config-input" id="secondary-project-id" placeholder="Project ID (e.g., your-backup-project)">
                <input type="text" class="config-input" id="secondary-api-key" placeholder="API Key">
                <input type="text" class="config-input" id="secondary-auth-domain" placeholder="Auth Domain">
                <button class="btn" onclick="addSecondaryDatabase()">
                    <i class="fas fa-plus"></i> Add Secondary Database
                </button>
            </div>
        </div>

        <!-- Database Operations -->
        <div class="card">
            <h2><i class="fas fa-tools"></i> Database Operations</h2>
            <button class="btn" onclick="testSyncWrite()">
                <i class="fas fa-sync"></i> Test Sync Write
            </button>
            <button class="btn" onclick="syncExistingData()">
                <i class="fas fa-copy"></i> Sync Existing Data
            </button>
            <button class="btn btn-secondary" onclick="enableRealTimeSync()">
                <i class="fas fa-broadcast-tower"></i> Enable Real-time Sync
            </button>
            <button class="btn btn-secondary" onclick="clearLog()">
                <i class="fas fa-trash"></i> Clear Log
            </button>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <h2><i class="fas fa-terminal"></i> Activity Log</h2>
            <div class="log-container" id="activity-log">
                <div>üî• Multi-Database system ready...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Multi-Database Scripts -->
    <script src="js/multi-firebase-config.js"></script>
    <script src="js/multi-database-service.js"></script>
    <script src="js/multi-database-implementation.js"></script>

    <script>
        // Demo functionality
        let activityLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            activityLog.push(logEntry);
            
            const logContainer = document.getElementById('activity-log');
            const logDiv = document.createElement('div');
            logDiv.textContent = logEntry;
            logDiv.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#fff';
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function checkDatabaseHealth() {
            log('üîç Checking database health...');
            try {
                const health = await window.MultiDBService.healthCheck();
                updateHealthDisplay(health);
                log('‚úÖ Health check completed');
            } catch (error) {
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        function updateHealthDisplay(health) {
            const container = document.getElementById('database-status');
            container.innerHTML = '';

            Object.entries(health).forEach(([name, status]) => {
                const statusCard = document.createElement('div');
                statusCard.className = `database-status ${status.status}`;
                statusCard.innerHTML = `
                    <h3><i class="fas fa-database"></i> ${name.toUpperCase()}</h3>
                    <p>Status: <strong>${status.status.toUpperCase()}</strong></p>
                    <p>Last Check: ${new Date(status.timestamp).toLocaleString()}</p>
                    ${status.error ? `<p style="color: #d32f2f;">Error: ${status.error}</p>` : ''}
                `;
                container.appendChild(statusCard);
            });
        }

        function addSecondaryDatabase() {
            const projectId = document.getElementById('secondary-project-id').value;
            const apiKey = document.getElementById('secondary-api-key').value;
            const authDomain = document.getElementById('secondary-auth-domain').value;

            if (!projectId || !apiKey || !authDomain) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const secondaryConfig = {
                    apiKey: apiKey,
                    authDomain: authDomain,
                    projectId: projectId,
                    storageBucket: `${projectId}.firebasestorage.app`,
                    messagingSenderId: "000000000000", // Placeholder
                    appId: "placeholder-app-id"
                };

                const secondaryApp = firebase.initializeApp(secondaryConfig, 'secondary');
                window.MultiDBService.addDatabase('secondary', secondaryApp, {
                    priority: 2,
                    type: 'backup'
                });

                log(`‚úÖ Secondary database '${projectId}' added successfully`, 'success');
                updateSyncStats();
            } catch (error) {
                log(`‚ùå Failed to add secondary database: ${error.message}`, 'error');
            }
        }

        async function testSyncWrite() {
            log('üß™ Testing sync write operation...');
            try {
                const testData = {
                    title: 'Test Reward',
                    description: 'This is a test reward for multi-database sync',
                    points: 100,
                    level: 'Bronze',
                    campus: 'all',
                    createdAt: new Date().toISOString()
                };

                const result = await window.MultiDBService.syncWrite('test_rewards', `test_${Date.now()}`, testData);
                log(`‚úÖ Sync write successful to: ${result.success.join(', ')}`, 'success');
                
                if (Object.keys(result.failed).length > 0) {
                    log(`‚ö†Ô∏è Failed databases: ${Object.keys(result.failed).join(', ')}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Sync write failed: ${error.message}`, 'error');
            }
        }

        async function syncExistingData() {
            log('üîÑ Starting existing data sync...');
            try {
                // This would sync your actual rewards data
                log('üìä Syncing rewards collection...');
                // Add actual sync logic here
                log('‚úÖ Existing data sync completed', 'success');
            } catch (error) {
                log(`‚ùå Data sync failed: ${error.message}`, 'error');
            }
        }

        function enableRealTimeSync() {
            log('üì° Enabling real-time sync...');
            try {
                // Setup real-time listeners
                window.MultiDBService.setupRealTimeSync('rewards');
                window.MultiDBService.setupRealTimeSync('competitions');
                log('‚úÖ Real-time sync enabled', 'success');
                updateSyncStats();
            } catch (error) {
                log(`‚ùå Failed to enable real-time sync: ${error.message}`, 'error');
            }
        }

        function updateSyncStats() {
            const stats = window.MultiDBService.getSyncStats();
            document.getElementById('db-count').textContent = stats.databases;
            document.getElementById('queue-size').textContent = stats.queueSize;
            document.getElementById('sync-status').textContent = stats.syncEnabled ? 'ON' : 'OFF';
        }

        function clearLog() {
            document.getElementById('activity-log').innerHTML = '<div>üî• Multi-Database system ready...</div>';
            activityLog = [];
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('üöÄ Multi-Database demo initialized');
            updateSyncStats();
            
            // Auto health check every 30 seconds
            setInterval(checkDatabaseHealth, 30000);
        });
    </script>
</body>
</html>
